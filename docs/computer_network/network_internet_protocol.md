## IP（Internet Protocol）协议

- 网络层包含：
    * 路由协议（路径选择，RIP,OSPF,BGP）
    * IP协议（地址约定，数据报格式，分组处理的约定）
    * ICMP协议(错误报告，路由器信令)

#### TP分片和重组（Fragmentation & Reassembly）

- 网络链路有MTU（最大传输单元）- 链路层帧所携带的最大数据长度
    * 不同的链路类型
    * 不同的MTU
- 大的IP数据报在网络上被分片（fragmented）
    * 一个数据报被分割成若干个小的数据报
        - 相同的ID
        - 不同的偏移量
        - 最后一个分片标记为0
    * "重组“只在最终的目标主机进行
    * IP头部的信息被用于标识，排序相关分片

## IP编址:引论

- IP地址：32位标示，对主机或路由器的接口编址
- 接口：主机/路由器和物理链路的连接处
    * 路由器通常拥有多个接口
    * 主机也可能有多个接口
    * IP地址和每一个接口关联
- ```一个IP地址和一个接口关联```

#### 子网（Subnets）

- IP地址：
    * 子网部分（高位bits）
    * 主机部分（低位bits）
- 什么是子网？
    * 一个子网内的节点（主机或路由器）他们的```IP地址的高位部分相同```，这些节点构成的网络叫子网
    * ```无需路由器介入```,子网内各主机可以在物理上相互直接到达

判断子网？
- 要判断一个子网，将每一个接口从主机或路由器上分开，构成了一个个网络的孤岛
- ```每一个孤岛（网络）都是一个，都可以被成为subnet```

#### 特殊IP地址

一些约定：
- 子网部分：全为0 -> 本网络
- 主机部分：全为0 -> 本主机
- 主机部分：全为1 -> 广播地址，这个网络的所有主机

#### 内网(专用)IP地址

- 专用地址：地址空间的一部分供专用地址使用
- 永远不会被当作公用地址来分配，不会与公用地址重复
    * 只在局域网络中有意义，区分不同的设备
- 路由器不对目标是专用地址的分组进行转发

```
专用地址范围:
Class A 10.0.0.0 - 10.255.255.255 MASK 255.0.0.0
Class B 172.16.0.0 - 172.31.255.255 MASK 255.255.0.0
Class C 192.168.0.0 - 192.169.255.255 MASK 255.255.255.0
```
#### IP编址：CIDP

CIDP：Classless InterDomain Routing(无类域路由)
- 子网部分可以在任意的位置
- 地址格式：```a.b.c.d/x```,其中x是地址中子网号的长度

#### 如何获得一个IP地址

主机如何获得一个IP地址？

```
系统管理员将地址配置在一个文件中
Wintel: control-panel -> network -> configuration -> tcp/ip -> properties
UNIX: /etc/rc/config

DHCP:(Dynamic Host Configuration Protocol):
从服务器中动态获得一个IP地址
”plug-and-play“
```

#### DHCP(Dynamic Host Configuration Protocol)

- 目标：允许主机在加入网络的时候，动态地从服务器那里获得IP地址：
    * 可以更新对主机在用IP地址的租用期 - 租期快到了
    * 重新启动时，允许重新使用以前用过的IP地址
    * 支持移动用户加入到该网络（短期在网）
- DNCP工作概况
    * 主机广播 ”DHCP discover“ 报文[可选]
    * DHCP服务器用 ”DHCP offer“ 提供报文相应[可选]
    * 主机请求IP地址：发送”DHCP request“ 报文
    * DHCP服务器发送地址： ”DHCP ack“ 报文
- 示例

```
1.联网笔记本需要获取自己的IP地址，第一跳路由器地址和DNS服务器：采用DHCP协议
2.DHCP请求被封装在UDP段中，封装在IP数据报中，封装在以太网的帧中
3.以太网帧在局域网范围内广播(dest:FFFFFFFF),被运行DHCP服务的路由器接收
4.以太网帧解封装成IP,IP解封装成UDP,解封装成DHCP
5.DHCP服务器生成DHCP ACK,包含客户端的IP地址，第一跳路由器的IP地址和DNS域名服务器的IP地址
6.DHCP服务器封装的报文所在的帧转发到客户端，在客户端解封装成DHCP报文
7.客户端知道它自己的IP地址，DNS服务器的名字和IP地址，第一跳路由器的IP地址
```

#### IP编址：如何获得一快地址

- 一个ISP如何获得一个地址块？
- ```ICANN```：Internet Corporation for Assigned Names and Numbers
    * 分配地址
    * 管理DNS
    * 分配域名，解决冲突
#### NAT(Network Address Translation)

- ```动机```：本地网络只有一个有效IP地址：
    * 不需要从ISP分配一块地址，可用一个IP地址用于所有的(局域网内)设备
    * 可以在局域网改变设备的地址情况下而无需通知外界
    * 可以改变ISP（地址变化）而不需要改变内部的设备地址
    * 局域网内部的设备没有明确的地址，对外是不可见的 -- 安全

- ```实现：NAT路由器```(必须)
    * 外出数据包:替换```原地址和端口号```为NAT IP地址和心得端口号，目标IP和端口号不变 ... 远端的C/S会用NAT IP地址，新端口号作为目标地址
    * 记住每个转换替换对(在NAT转换表中) ...源IP,端口vs NAT IP,新端口
    * 导入数据包:替换```目标IP地址和端口号```，采用存储在NAT表中的mapping表项，用(源IP,端口)

```
 16-bit端口字段：
     6万多个同时连接，一个局域网！
 对NAT是有争议的：
     路由器只应该对第3层做信息处理，而这里对端口号(4层)做了处理
     违反了end-to-end原则
        端到端原则:复杂性放到网络边缘
            无需借助中转和变换，就可以直接传送到目标主机
        NAT可能要被一些应用设计者考虑，eg,p2p applications
        外网的机器无法主动连接到内网的机器上
    地址短缺问题可以被IPv6解决
    NAT穿越：如果客户端需要连接在NAT后面的服务器，如何操作
 ```  

#### NAT穿越问题（略）
    
- 客户端需要连接地址为10.0.0.1的服务器
    * 服务器地址10.0.0.1 LAN本地地址（客户端不能够使用其作为目标地址）
    * 整网只有一个外部可见地址：138.76.29.7
- 方案1：静态配置NAT：转发进来的对服务器特定端口连接请求
    * e.g.,(123.76.29.7 port 2500),总是转发到10.0.0.1 port 25000

- 方案2：Universal plug and Play(UPnP) Internet Gateway Device(IGD)协议，允许NATted主机可以：
    * 获知网络的公共IP地址138.76.28.7
    * 列举存在的端口映射
    * 增/删端口映射（在租用时间内）
    * i.e.,自动化静态NAT端口映射配置
- 方案3：中继(used in Skype)
    * NAT后面的服务器建立和中继的连接
    * 外部的客户端链接到中继
    * 中继在2个连接之间桥接

## IPv6

动机：
- ```初始动机```：32-bit地址空间很快会用完
- 另外的动机：
    * 头部格式改变帮助加速处理和转发
        - TTL-1
        - 头部checksum
        -分片
    * 头部格式改变帮助QoS(quantity of service)

IPv6数据报格式：
- 固定的40字节头部
- 数据报传输过程中，不允许分片


















