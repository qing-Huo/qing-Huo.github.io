## 数据链路层

基本概念

```
结点：
    主机，路由器
链路：
    网络中两个节点之间的 物理通道，链路的传输介质有双绞线，光纤和微波
    分为有线链路，无线链路
数据链路：
    网络中两个节点之间的 逻辑通道，把实现控制数据传输 协议 的硬件和
    软件加到链路上就构成数据链路
帧：
    链路层的协议数据单元，封装网络层数据报
数据链路层负责通过一条链路从另一个节点向另一个物理链路直接相连的
相邻节点传送数据报
```

数据链路层功能概述：

数据链路层在物理层提供服务的基础上```向网络层提供服务```，其最基本的服务是将源自网络层来的数据```可靠```地差u念书到相邻节点的目标机网络层。其主要作用是```加强物理层传输原始比特流的功能```，将物理层提供的可能出错的物理连接改造成```逻辑上无差错的数据链路```，使之对网络层表现为一条无差错的链路。

- 为网络层提供服务
    * 无确认无连接服务
    * 有确认无连接服务
    * 有确认面向连接服务(有连接一定有确认)
- 链路管理
    * 即建立的连接，维持，释放(用于面向连接的服务)
- 组帧
- 流量控制(限制发送方)
- 差错控制(帧错/位错)

#### 封装成帧和透明传输

```封装成帧```就是在一段数据的前后部分添加首部和尾部，这样就构成了一个帧。

接收端在受到物理层上较的比特流后，就能根据首部和尾部的标记，从受到的比特流中识别帧的开始和结束

首部和尾部包含许多的控制信息，他们的一个重要作用：```帧定界(确定帧的界限)```

```帧同步```：接收方应当能从接收到的二进制比特流中区分出帧的起始和终止

- 组帧的4种方法：
    * 字符计数法
    * 字符（节）填充法
    * 零比特填充法
    * 违规编码法
- 透明传输

```
透明传输 是指不管所传数据是什么样的比特组合，都应当能够在链路上传送。
因此，链路层就 “看不见” 有什么妨碍数据传输的东西
当所传数据中的比特组合恰巧与某一个控制信息完全一样时，就必须采取适当的
措施，使收方不会将这样的数据误认为是某种信息。这样才能保证数据链路层
的传输是透明的
```
- 字符计数法
    * 帧首部使用一个计数字段(第一个字节，8位)来表明帧内字符数
    * 缺点是 鸡蛋装载一个篮子里
- 字符填充法

```
数据首部有SOH,尾部有EOT
SOH(Start of Header)
EOT(End of Transmission)
当传送的帧是由文本文件组成时(文本文件的字符都是从键盘输入，都是ASCII码).不管从键盘上输入什么字符都可以放在帧里传过去，即```透明传输```
当传送的帧由非ASCII码的文本文件组成(二进制代码的程序或图像),就要采用```字符填充方法实现透明传输```
```

- 零比特填充法
    
```
在发送端，扫描整个信息字段，只要连续5个1,就立即填入1个0
在接收端受到一个帧时，先找到标志字段确认边界，再用硬件对比比特流进行
扫面，发现连续5个1时，就把后面的0删除
保证了透明传输：
    在传送的比特流中可以传送任意比特组合，而不会引起对帧边界的判断错误
note: 零比特填充法，数据帧的首尾依旧有标志位
```

- 违规编码法

```
由于曼彻斯特编码中会对一个比特分为两半进行表示(低-高，高-低)
所以可以用 高-高，低-低 来定界帧的起始和终止
由于字节计数法中Count字段的脆弱性(其值若有差错将导致严重后果)及字符填充
实现上的复杂性和不兼容性，目前普遍使用的帧同步法是
    比特填充和违规编码法
```
## 差错控制

- 差错从何而来？

```
概括来说，传输中的差错都是由于噪声引起的
全局性：
    由于线路本身电气特性所产生的 随机噪声(热噪声)，是信道固有的，随机存在
    解决办法：提高信噪比来减少或避免干扰(对传感器下手)
局部性：
    外界特性的短暂原因所造成的 冲击噪声，是产生差错的主要原因
    解决办法：通常利用编码技术来解决
```
- 数据链路的编码

```
数据链路中差错控制是针对 比特错
解决方案有
    检错编码(奇偶校验码， 循环冗余码CRC)
    纠错编码(海明码)
数据链路层编码和物理层的数据编码与调制 不同，
物理层编码针对的是 单个比特，解决传输过程中比特的同步等问题
比如曼彻斯特编码。
而数据链路层的编码针对的是 一组比特，它通过冗余码的技术实现了
一组二进制比特串在传输过程中是否出现了差错
```
- 冗余编码

```
在数据发送之前，先按某种关系 附加 上一定的冗余位，构成一个符合某一个
规则的码字后在发送
当要发送的有效数据变化时，相应的冗余位也随之变化，使码字遵从不便的规则。
接受端根据受到的码字是否仍符合原规则，从而判断是否出错
```
- 奇偶校验码

```
奇偶校验码由 n-1位信息元 和 1位校验元 组成
奇校验码:"1"的个数为奇数
偶校验码:"1"的个数为偶数
奇偶校验码的特点：
    只能检查出 奇数个比特 错误，检错能力50%
```

- CRC循环冗余码
    * 略
- 海明码
    * 可以发现```双比特错```，只能纠正单比特错
    * 略

## 流量控制与可靠传输

- 流量控制
    * ```较高的发送速度```和较低的接受能力```不匹配，会造成传输出错，因此流量控制也是数据链路层的一项重要工作  
    * 数据链路层的流量控制是```点对点```，传输层的流量控制是```端到端```
    * 数据链路层流量控制手段：接收方收不下就不回复确认
    * 传输层流量控制手段：接收端给发送端一个窗口公告

```
数据链路层流量控制协议
停止-等待协议：(发送窗口大小=1,接受窗口大小=1)
    每发送完一个帧就停止发送，等待对方的确认，在受到确认后再发送下一个帧
滑动窗口协议：
    后退N帧协议GBN (发送窗口大小>1,接受窗口大小=1)
    选择重传协议SR (发送窗口大小>1,接受窗口大小>1)

可靠传输：发送端发啥，接收端收啥
流量控制：控制发送速率，使接收方有足够的缓冲空间来接受每一个帧
滑动窗口：
    流量控制：收不下就不给确认，想发也发不了
    可靠传输：发送方自动重传
```

#### 停止等待协议

- 为什么要有停止-等待协议？
    * 除了```比特出差错```，底层信道还会出现丢包问题及实现流量控制
    * 丢包(物理线路故障，设备故障，病毒攻击，路由信息错误等原因会造成数据包丢失) 
- 停止等待协议有几种应用情况？
    * 无差错情况
    * 有差错情况
#### 传输数据使用的两种链路

- 点对点链路
    * 两个相邻节点通过一个链路相连，没有第三者
    * 应用：PPP协议，常用于```广域网```
- 广播式链路
    * 所有主机共享通信介质
    * 应用：早期的总线以太网，无线局域网，常用于```局域网```
    * 典型拓扑结构：总线型，星型(逻辑总线型)

- 介质访问控制

```
介质访问控制的内容：
    采取一定的措施，使得两对节点之间的通信不会发生互相干扰的情况
介质访问控制：
    静态划分信道：
        信道划分介质访问控制：
            频分多路复用 FDM
            时分多路复用 TDM
            波分多路复用 WDM
            码分多路复用 CDM
    动态分配信道：
        轮询访问介质访问控制：
            令牌传递协议
        随机访问介质访问控制：
            ALOHA协议
            CSMA协议
            CSMA/CD协议
            CSMA/CA协议
```

#### 信道划分介质访问控制

信道划分介质访问控制:

将使用介质的每个设备与来自同一信道上的其他设备的```通信隔离```开，把```时域和频域资源```合理地分配给网络上的设备

多路复用技术：

把多个信号整合在一条物理信道上进行传输，使得多个计算机或中断设备```共享信道资源```，提高信道利用率

把一条广播信道，逻辑上分成几条用于两个节点之间通信的互不干扰的子信道，```实际就是把广播信道转变为点对点信道```

#### 频分多路复用FDM

用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。```频分复用的所有用户在同样的时间占用不同的带宽(频率带宽)资源```

其充分利用传输介质带宽，系统```效率较高```，由于技术比较成熟，实现也比较容易

#### 时分多路复用TDM

将时间划分为一段段等长的时分复用帧(TDM帧)。每一个时分复用的用户在每一个TDM帧中占用```固定序号的时隙```，所有用户轮流占用信道
- TDM帧是在物理层传送的比特流所划分的帧，标志一个周期
- 频分复用 -- “并行”
- 时分复用 -- “并发”

改进的时分复用 -- 统计时分复用STDM

每一个STDM帧中的时隙```小于```连接在集中器上的用户数。各用户有了数据就随时发往集中器的```输入缓存```，然后集中器按顺序一次扫描输入缓存，把缓存中的输入数据放入STDM帧中，一个STDM帧满了就发出。

STDM帧不是固定分配时隙，而是按需动态分配时隙

#### 波分多路复用WDM

波分多路复用就是```光的频分多路复用```，在一根光纤中传输多重不同波长(频率)的光信号，由于波长(频率)不同，所以各路光信号互不干扰，最后再用波长分解复用器将各路波长分解出来

#### 码分多路复用CDM

```码分多址(CDMA)```是码分复用的一种方式

1个比特分为多个码片/芯片(chip),每一个站点被指定一个唯一的m位的芯片序列。发送1时站点发送芯片序列，发送0时发送芯片序列反码(通常把0写成-1)

如何不打架：多个站点同时发送数据的时候，要求各个站点芯片序列互相正交

如何合并：各路数据在信道中被线性相加

如何分离：合并的数据和源站规格化内积

#### 动态分配信道

动态分配信道又称动态媒体接入控制/多点接入

特点：信道并非在用户通信时固定分配给用户

随机访问介质访问控制: 所有用户可随机发送信息。发送信息是占```全部带宽```
#### ALOHA协议

纯ALOHA协议思想：不监听信道，不按时间槽发送，随机重发。想发就发

冲突如何检测：如果发生冲突，接收方就会检测出差错，然后不予确认，发送方在一定时间内收不到就判断发生冲突

冲突如何解决：超时后等一随机时间再重传

时隙ALOHA协议思想：把时间分成若干个相同的时间片，所有用户在时间片开始时刻同步接入网络信道，若发生冲突，则必须等到下一个时间片开始时刻再发送,控制想发就发的随意性

- 纯ALOHA比时隙ALOHA吞吐量更低，效率更低
- 纯ALOHA想发就发，时隙ALOHA只有在时间片段开始时才能发

#### CSMA协议

载波监听多路访问控制协议CSMA(Carrier Sense Multiple Access)

CS：载波侦听/监听，每一个站在发送数据之前要检测一下总线上是否有其他计算机在发送数据

当几个站同时在总线上发送数据时，总线上的信号```电压摆动值```将会增大(互相叠加)。当一个站检测到的信号电压摆动值超过一定门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞，即发生了冲突。

MA：多点介入，表示许多计算机以多点介入的方式连接在一根总线上

协议思想：发送帧之前，```监听```信道

监听结果：信道空闲 发送完整帧 信道忙 推迟发送

```
- 1-坚持CSMA
- 坚持之的是对于舰艇信道```忙```之后的坚持
- 1-坚持CSMA思想：如果一个主机要发送消息，那么它先监听信道
    * 空闲则直接传输，不必等待
    * 忙则一直监听，直到空闲马上传输
    * 如果有冲突(一段时间内未受到肯定回复),则等待一个随机长的时间再监听，重复上述过程
- 优点：只要媒体空闲，站点就马上发送，避免了媒体利用率的损失
- 缺点：假如有两个或两个以上的站点有数据要发送，冲突就不可避免
```

- 非坚持CSMA

```
非坚持之的是对于监听信道 忙 之后就不继续监听
非坚持CSMA思想：如果一个主机要发送信息，那么它先监听信道
    空闲则直接传输，不必等待
    忙则等待一个随机的时间之后再进行监听
优点：
    采用随机的重发延迟时间可以减少冲突发生的可能性
缺点：
    可能存在大家都在延迟等待过程中，使得媒体仍可能处于空闲状态，媒体使用率降低
```
- p-坚持CSMA

```
p-坚持指的是对于监听信道 空闲 的处理
p-坚持CSMA思想：如果一个主机要发送消息，那么它先监听信道
    空闲则以p概率直接传输，不必等待，概率1-p等待到下一个时间槽再传输
    忙则等待一个随机的时间之后再进行监听
优点：
    技能像非坚持算法那样减少冲突，又能像1-坚持算法那样减少媒体空闲时间
缺点：
    发生冲突后还是要坚持把数据帧发送完，造成了浪费
```

#### 轮询访问介质访问控制

```
信道划分介质访问控制 (MAC Multiple Access Control)协议：
    基于 多路复用 技术划分资源
    网络负载重：共享信道效率高，且公平
    网络负载轻：共享信道效率低
随机访问MAC协议： 会冲突
    用户根据意愿 随机 发送消息，发送消息时可独占信道带宽
    网络负载重：产生冲突开销
    网络负载轻：共享信道效率高，单个节点可利用信道全部带宽
轮询访问MAC协议/轮流协议/轮转访问MAC协议： （轮询协议，令牌传递协议）
    既 不产生冲突，又要发送时 占全部带宽
```
- 轮询协议：
    
主节点轮流“邀请”从属节点发送数据

缺点：

轮询开销，等待延迟，单点故障

- 令牌传递协议

```
令牌：
    一个特殊格式的MAC控制帧，不含任何信息
    控制信道的使用，确保同一时刻只有一个节点独占信道
    令牌环网无碰撞
    每个节点都可以在一定的时间内(令牌持有时间)获得发送数据的权力，
    并不是无限制的持有令牌
问题：
    令牌开销，等待延迟，单点故障
    应用于令牌环网(物理星形拓扑结构，逻辑环形拓扑)
    采用令牌传送方式的网络常用于 负载较重，通信量较大 的网络中
```

#### CSMA/CA协议

载波监听多点接入/碰撞避免CSMA/CA(Carrier Sense Multiple Access With Collision Avoidance)

为什么要有CSMA/CA协议？

因为CSMA/CA应用于无线局域网(解决了全面检测碰撞和隐蔽站的问题)

- CSMA/CA协议工作原理

```
发送数据前，先检测信道是否空闲
空闲则发出RTS(Request To Send),
    RTS包括发射端地址，接收端地址，下一份数据将持续发送的时间等信息，信道忙则等待
接受端收到RTS后，响应CTS(CLear To Send)
发送端收到CTS后，开始发送数据帧(同时 预约信道：发送方告知其他站点自己要传多久数据)
接收端受到数据帧后，将用CRC来检验数据是否正确，正确则相应ACK帧
发送方受到ACK就可以进行下一数据帧的发送，若没有则一直重传至规定重发次数为止
    采用二进制指数退避算法来确认随机的推迟时间
```

#### CSMA/CD协议
载波监听多点接入/碰撞检测CSMA/CD(Carrier Sense Multiple Access With Collision Detection)
```
CS:载波监听/侦听 每一个站在 发送数据之前 及 发送数据时 都要检测一下总线
    上是否还有其他计算机在发送数据
MA:多点介入，表示许多计算机以多点接入的方式连接在一根总线上(总线型网络)
CD:碰撞检测(冲突检测)，“边发送边监听”，适配器边发送数据边检测信道上信号
    电压的变化，以便判断自己在发送数据时其他站点是否也在发送数据(半双工)

为什么先听后发还会冲突？
    因为电磁波在总线上总是以有限的速率传播的
```

## 局域网

局域网(Local Area Network):简称LAN,是指在```某一区域内```由多台计算机互联成的计算机组，使用```广播信道```

```
特点：
覆盖的地理范围较小，只在一个相对独立的局部范围内互联，如一座或集中的建筑群内
使用专门铺设的传输介质（双绞线，同轴电缆）进行联网，数据传输速率高(10Mb/s~10Gb/s)
通信延迟时间短，误码率低，可靠性较高
各站点平等关系，共享传输信道
多采用分布式控制和广播式通信，能进行广播和组播

决定局域网的主要要素为：
    网络拓扑，传输介质和介质访问控制方法
```

- 局域网拓扑结构

```
星型拓扑：(需要集线器)
    中间两节点是控制中心，任意两个节点间的通信最多只需2步，传输速度快
    并且网络构形简单，建网容易，便于控制和管理
    但这种网络系统，网络可靠性低，网络共享能力差，有单点故障问题
总线型拓扑：(最常用)
    网络可靠性高，网络节点间相应速度快，共享资源能力强，设备投入量少，
    成本低，安装使用方便，当某个工作站节点出现故障时，影响小
环形拓扑：
    系统中通信设备和线路比较节省。有 单点故障问题
    不便于扩充，系统相应延时长，且信息传输效率低
树形拓扑：
    易于扩展，易于隔离故障，容易有 单点故障
```

- 局域网介质访问控制方法

```
CSMA/CD 常用于 总线型局域网，也用于树型网络
令牌总线    常用于 总线型网络，也用于树形网络
    它把总线型或树型网络中的各个工作站按一定顺序，如按接口地址大小排列
    形成一个逻辑环。只有令牌持有者才能控制总线，才有发送信息的权力
令牌环  用于 环形局域网，如令牌环网
```
- 局域网的分类

```
以太网
    以太网是应用最为广泛的局域网，包括标准以太网(10Mbps),快速以太网(
    100Mbps),千兆以太网(1000Mbps)和10G以太网，他们符合IEEE802.3系列
    标准规范。逻辑拓扑总线型，物理拓扑是星型或扩展星型，采用CSMA/CD
令牌环网
    物理上采用了星型拓扑结构，逻辑上是环形拓扑结构，已是“昨日黄花”
FDDI网(Fiber Distributed Data Interface)
    物理上采用了双环拓扑结构，逻辑上是环形拓扑结构
ATM网(Asynchronous Transfer Mode)
    较新型的单元交换技术，采用53字节固定长度的单元进行交换
无线局域网(Wireless Local Area Network: WLAN)
    采用IEEE 802.11标准
```
- IEEE802标准

IEEE802系列标准是IEEE 802 LAN/MAN标准委员会制定的局域网，城域网技术标准（1980年2月成立）。其中最广泛使用的有以太网，令牌环，无线局域网等。这一系列标准中的每一个自标准都有委员会中的一个专门工作组负责

#### MAC子层和LLC子层

IEEE 802标准所描述的局域网参考模型只对应OSI参考模型的```数据链路层和物理层```，它将数据链路层划分为逻辑链路层LLC子层和介质访问控制MAC子层

```
LLC负责识别网络层协议，然后对它们进行封装。LLC包头告诉数据链路层一旦
帧被接收到时，应当对数据包佐贺处理。为网络层提供服务：
无确认无连接，面向连接，带确认无连接，高速传送

MAC子层的主要功能包括数据帧的封装/卸装，帧的寻址和识别，帧的接收与发送，
链路的管理，帧的差错控制等。
MAC子层的存在屏蔽了不同物理链路种类的差异性
```

#### 以太网

以太网(Ethernet)指的是由Xerox公司创建并由Xerox,Intel和DEC公司联合开发的```基带总线局域网规范```，是当今现有局域网采用的最通用的通信协议标准。以太网络使用```CSMA/CD```(载波监听多路访问及冲突检测)技术。

```
以太网在局域网各种技术中占 统治性 地位
    造假低廉(以太网网卡不到100块)
    是应用最广泛的局域网技术
    比令牌环网，ATM网便宜，简单
    满足网络速率要求：10Mb/s ~ 10Gb/s

以太网两个标准
DIX Ethernet v2: 第一个局域网产品(以太网)规约
IEEE 802.3： IEEE802委员会802.3工作组制定的第一个IEEE的以太网标准
    （帧格式有一点点改动）
```
- 以太网提供无连接，不可靠的服务
- 无连接：发送方和接收方之间无“握手过程”
- 不可靠：部队发送方的数据帧```编号```，接收方不向发送方进行```确认```，差错帧直接丢弃，差错纠正由高层负责
- 以太网之实现无差错接受，不实现可靠传输

- 10BASE-T以外网
10BASE-T是传送```基带信号```的双绞线以太网，T表示采用双绞线，现10BASE-T采用的是```无屏蔽双绞线```(UTP),传输速率是10Mb/s

```物理上采用星形拓扑，逻辑上总线型```，每段双绞线最常100m

采用```曼彻斯特编码```，采用```CSMA/CD```介质访问控制

#### 适配器与MAC地址

计算机与外界有局域网的连接是通过```通信适配器(网卡)```的

```
通信适配器别名：
    网络接口板
    网络接口卡NIC(Network Interface Card)
现在不再使用单独网卡，适配器上装有处理器和存储器(包括RAM和ROM)
ROM上有计算机硬件地址 MAC地址

在语句往中，硬件地址又成为物理地址或 MAC地址(实际上是标识符)
MAC地址：
    每个适配器有一个全球唯一的48位二进制地址，前24位代表厂家(由IEEE规定
)
    后24位厂家自己指定。通常6个16进制数表示
```
- 以太网MAC帧
    * 最常用的MAC帧是以太网v2的格式
- 高速以太网
    * 速率>=100Mb/s的以太网称为高速以太网

## 无线局域网

IEEE 802.11是```无线局域网```通用的标准，它由IEEE定义的无线网络通信的标准

无线局域网包括wifi

- 无线局域网的分类
    * 有固定基础设施的无线局域网
    * 无固定基础设施的自组织网络
## 广域网

广域网(WAN,Wide Area Network),通常跨接很大的物理范围，所覆盖的范围从几十公里到几千公里，他能连接多个城市或国家，或横跨几个洲并能提供远距离通信，形成国际性的远程网络

广域网的通信子网主要使用```分组交换```技术。广域网的通信子网可以利用公用分组交换网，卫星通信网和无限分组交换网，他能将分布在不同地区的```局域网或计算机系统```互联起来，达到```资源共享```的目的。如因特网(Internet)是世界范围内最大的广域网

- PPP协议的特点
点对点协议PPP(Point-to-Point Protocol)是目前最广泛使用的数据链路层协议，用户使用拨号电话介入因特网时一般都使用PPP协议

PPP协议只支持全双工链路

- PPP协议应满足的要求

```
简单    对于链路层的帧，无需纠错，无需序号，无需流量控制
封装成帧    帧定界符
透明传输    与帧定界符一样比特组合的数据应该如何处理：
            异步线路用字节填充，同步线路用比特填充
多种网络层协议  封装的IP数据报可以采用多种协议
差错检测    错就丢弃
检测连接状态    链路是否正常工作
最大传输单元    数据部分最大长度MTU
网络层地址协商  知道通信双方的网络地址
数据压缩协商
```
- PPP协议的三个组成部分

```
一个将IP数据报封装到串行链路(同步串行/异步串行)的方法

链路控制协议LCP：建立并维护数据链路连接。(身份验证)

网络控制协议NCP：
    PPP可支持多种网络层协议,每个不同的网络层协议都要一个相应的NCP来配置
    为网络层协议建立和配置逻辑连接
```

#### HDLC协议
高级数据链路控制(High-Level Data Link Control,HDLC)，是一个在同步网上传输数据，```面向比特```的数据链路层协议，它是由国际标准化组织(ISO)根据IBM的SDLC(SynchronousData Link Control)协议扩展开发而成的。

数据报文可透明传输，用于实现透明传输的“0比特插入法”易于硬件实现

采用全双工通信

所有帧采用CRC检验，对信息帧进行顺序```编号```，可防止漏收或重传，传输可靠性高

- HDLC的站

```
主战，从站，复合站
主站的功能：收发命令(包括数据信息)帧，接收相应帧，并负责对整个链路的控
    制系统的初启，流程的控制，差错检测或恢复等
从站的功能：接收来自主战发来的命令帧，向主站发送相应帧，并且配合主战参
     与差错恢复等链路控制
复合站的主要功能：既能发送，又能接收命令帧和相应帧，并且负责整个链路的控制

3种数据操作方式
    正常相应方式
    异步平衡方式
    异步响应方式
```
- PPP协议 VS HDLC协议
    * HDLC,PPP只支持```全双工```链路
    * 都可以实现透明传输
    * 都可以实现差错控制，但不纠正差错














